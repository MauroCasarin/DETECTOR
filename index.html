
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Detector Local de Autos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js and COCO-SSD Model CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
        }
        #video, #canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-black text-white font-sans flex flex-col h-screen overflow-hidden">

    <!-- Header con contador -->
    <header id="header" class="absolute top-0 left-0 right-0 p-4 bg-black/60 backdrop-blur-sm z-20 text-center hidden">
        <h1 class="text-2xl font-bold tracking-wider">
            Vehículos Detectados: <span id="vehicle-count" class="text-green-400">0</span>
        </h1>
    </header>

    <!-- Contenedor principal para video y canvas -->
    <main id="scanner-view" class="flex-grow relative w-full h-full hidden">
        <video id="video" playsinline muted autoplay class="z-0"></video>
        <canvas id="canvas" class="z-10"></canvas>
    </main>

    <!-- Vista inicial con el botón -->
    <div id="start-view" class="flex flex-col items-center justify-center flex-grow p-4 text-center">
        <div id="loading" class="hidden mb-8 text-center">
            <div class="w-12 h-12 border-4 border-green-400 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="mt-4 text-gray-300">Cargando modelo de IA...</p>
        </div>
        <div id="start-content">
            <h1 class="text-4xl font-bold mb-2 text-green-400">Detector de Vehículos</h1>
            <p class="text-gray-400 mb-8">Análisis local en tiempo real con TensorFlow.js</p>
            <button id="start-button" class="bg-green-500 text-black font-bold text-xl px-10 py-5 rounded-full shadow-lg shadow-green-500/30 transform hover:scale-105 transition-transform duration-300">
                ENCENDER ESCÁNER LOCAL
            </button>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const startView = document.getElementById('start-view');
        const scannerView = document.getElementById('scanner-view');
        const header = document.getElementById('header');
        const startButton = document.getElementById('start-button');
        const loadingDiv = document.getElementById('loading');
        const startContent = document.getElementById('start-content');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const vehicleCountSpan = document.getElementById('vehicle-count');
        const ctx = canvas.getContext('2d');

        // --- STATE & CONFIG ---
        let model = null;
        let lastVehicleCount = -1;
        const VEHICLE_CLASSES = ["car", "truck", "bus"];

        // --- SPEECH SERVICE ---
        const speechService = {
            synth: window.speechSynthesis,
            voices: [],
            speaker1: null, // Announcement
            speaker2: null, // Feedback
            loadVoices() {
                this.voices = this.synth.getVoices();
                if (this.voices.length > 0) {
                    const esVoices = this.voices.filter(v => v.lang.startsWith('es'));
                    this.speaker1 = esVoices.find(v => v.name.includes('Jorge') || v.name.includes('Google español')) || esVoices[0] || this.voices[0];
                    this.speaker2 = esVoices.find(v => v.name.includes('Monica') || v.name.includes('Paulina')) || (esVoices.length > 1 ? esVoices[1] : null) || this.voices[1] || this.speaker1;
                }
            },
            speak(text, speakerType) {
                if (!this.synth || this.synth.speaking) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-MX';
                if (speakerType === 'announcement' && this.speaker1) {
                    utterance.voice = this.speaker1;
                    utterance.rate = 1.1;
                } else if (speakerType === 'feedback' && this.speaker2) {
                    utterance.voice = this.speaker2;
                    utterance.rate = 1;
                }
                this.synth.speak(utterance);
            }
        };
        speechService.loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => speechService.loadVoices();
        }

        // --- DETECTION & DRAWING ---
        async function detectFrame() {
            if (!model || video.paused || video.ended) {
                return;
            }

            const predictions = await model.detect(video);
            
            const vehiclePredictions = predictions.filter(p => VEHICLE_CLASSES.includes(p.class));

            drawBoundingBoxes(vehiclePredictions);

            const currentVehicleCount = vehiclePredictions.length;
            vehicleCountSpan.textContent = currentVehicleCount;

            if (currentVehicleCount !== lastVehicleCount) {
                if (currentVehicleCount > 0) {
                    const vehicleText = currentVehicleCount === 1 ? 'vehículo detectado' : 'vehículos detectados';
                    speechService.speak(`${currentVehicleCount} ${vehicleText}`, 'announcement');
                }
                lastVehicleCount = currentVehicleCount;
            }

            requestAnimationFrame(detectFrame);
        }

        function drawBoundingBoxes(predictions) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px sans-serif';
            ctx.textBaseline = 'top';

            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;

                // Styling the bounding box
                ctx.strokeStyle = '#22c55e'; // green-500
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);

                // Styling the label background
                const label = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                const textWidth = ctx.measureText(label).width;
                ctx.fillStyle = '#22c55e';
                ctx.fillRect(x, y, textWidth + 10, 20);

                // Styling the label text
                ctx.fillStyle = '#000000';
                ctx.fillText(label, x + 5, y + 2);
            });
        }

        // --- MAIN LOGIC ---
        async function startScanner() {
            startContent.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                // Load model and camera in parallel
                const modelPromise = cocoSsd.load();
                const streamPromise = navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });

                const [loadedModel, stream] = await Promise.all([modelPromise, streamPromise]);
                model = loadedModel;

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                };
                
                video.onplay = () => {
                    startView.classList.add('hidden');
                    scannerView.classList.remove('hidden');
                    header.classList.remove('hidden');
                    speechService.speak("Escáner local listo.", 'feedback');
                    detectFrame();
                };

            } catch (err) {
                console.error("Error al iniciar el escáner:", err);
                alert("No se pudo iniciar el escáner. Por favor, verifica los permisos de la cámara.");
                startContent.classList.remove('hidden');
                loadingDiv.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        startButton.addEventListener('click', startScanner);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
